# План рефакторинга: Session Object Pattern

## Проблема

Сейчас каждая сессия в Telegram боте сохраняется отдельными ключами в session:
- `:edit_time_shift_id`, `:edit_original_values`, `:edit_field`, `:edit_new_project_id`, `:edit_new_hours`, `:edit_new_description`
- `:adduser_project_slug`, `:adduser_username`
- `:add_time_project_id`

Это нарушает принципы SOLID:
1. Пользователь НЕ может находиться одновременно в нескольких сессиях
2. Для очистки сессий нужно знать ВСЕ ключи

## Решение

Использовать Session Object Pattern - единый объект для управления состоянием сессии.

---

## Этап 1: Подготовка и создание базовой инфраструктуры

### 1.1 Создание базового класса TelegramSession
- [ ] 1.1.1 Создать файл `app/models/telegram_session.rb`
- [ ] 1.1.2 Реализовать базовый класс с атрибутами `type` и `data`
- [ ] 1.1.3 Добавить методы `to_h` и `self.from_h` для сериализации
- [ ] 1.1.4 Добавить метод `valid?` для валидации структуры данных

### 1.2 Создание специализированных классов сессий
- [ ] 1.2.1 Создать `TelegramSession::Edit` для редактирования записей
- [ ] 1.2.2 Создать `TelegramSession::AddUser` для добавления пользователей
- [ ] 1.2.3 Создать `TelegramSession::AddTime` для добавления времени
- [ ] 1.2.4 Добавить фабричные методы в базовый класс

### 1.3 Создание хелперов в контроллере
- [ ] 1.3.1 Добавить метод `telegram_session` для получения текущей сессии
- [ ] 1.3.2 Добавить метод `telegram_session=` для установки сессии
- [ ] 1.3.3 Добавить метод `clear_telegram_session` для очистки
- [ ] 1.3.4 Добавить метод `telegram_session_data` для удобного доступа к данным

## Этап 2: Написание тестов

### 2.1 Тесты для TelegramSession
- [ ] 2.1.1 Создать `spec/models/telegram_session_spec.rb`
- [ ] 2.1.2 Написать тесты для сериализации/десериализации
- [ ] 2.1.3 Написать тесты для валидации данных
- [ ] 2.1.4 Написать тесты для фабричных методов

### 2.2 Тесты для специализированных классов
- [ ] 2.2.1 Создать `spec/models/telegram_session/edit_spec.rb`
- [ ] 2.2.2 Создать `spec/models/telegram_session/add_user_spec.rb`
- [ ] 2.2.3 Создать `spec/models/telegram_session/add_time_spec.rb`
- [ ] 2.2.4 Проверить все сценарии использования

### 2.3 Обновление существующих тестов контроллера
- [ ] 2.3.1 Обновить `spec/controllers/concerns/telegram_callbacks_spec.rb`
- [ ] 2.3.2 Добавить тесты для новых хелперов
- [ ] 2.3.3 Убедиться, что все существующие тесты проходят

## Этап 3: Рефакторинг Edit сессии (самая сложная)

### 3.1 Рефакторинг edit_select_time_shift_input
- [ ] 3.1.1 Заменить 6 отдельных ключей на `TelegramSession::Edit`
- [ ] 3.1.2 Обновить сохранение в `session[:telegram_session]`
- [ ] 3.1.3 Убедиться, что все данные корректно сохраняются

### 3.2 Рефакторинг edit_field_callback_query
- [ ] 3.2.1 Обновить чтение данных через `telegram_session`
- [ ] 3.2.2 Обновить запись `field` в сессию
- [ ] 3.2.3 Обновить логику отмены с использованием `clear_telegram_session`

### 3.3 Рефакторинг edit_project_callback_query
- [ ] 3.3.1 Обновить чтение/запись `new_project_id`
- [ ] 3.3.2 Обновить метод `show_edit_confirmation`

### 3.4 Рефакторинг edit_hours_input и edit_description_input
- [ ] 3.4.1 Обновить `edit_hours_input` для работы с новой структурой
- [ ] 3.4.2 Обновить `edit_description_input` для работы с новой структурой
- [ ] 3.4.3 Убедиться, что валидация работает корректно

### 3.5 Рефакторинг show_edit_confirmation
- [ ] 3.5.1 Обновить чтение всех данных через `telegram_session_data`
- [ ] 3.5.2 Упростить логику формирования changes
- [ ] 3.5.3 Убедиться, что все поля корректно отображаются

### 3.6 Рефакторинг edit_confirm_callback_query
- [ ] 3.6.1 Обновить чтение данных
- [ ] 3.6.2 Заменить множественные `session.delete` на `clear_telegram_session`
- [ ] 3.6.3 Проверить корректность сохранения изменений

## Этап 4: Рефакторинг AddUser сессии

### 4.1 Рефакторинг adduser_project_callback_query
- [ ] 4.1.1 Заменить `session[:adduser_project_slug]` на `TelegramSession::AddUser`
- [ ] 4.1.2 Обновить сохранение в сессию

### 4.2 Рефакторинг adduser_username_input
- [ ] 4.2.1 Обновить чтение `project_slug`
- [ ] 4.2.2 Обновить сохранение `username`

### 4.3 Рефакторинг adduser_role_callback_query
- [ ] 4.3.1 Обновить чтение `project_slug` и `username`
- [ ] 4.3.2 Заменить множественные `session.delete` на `clear_telegram_session`

## Этап 5: Рефакторинг AddTime сессии

### 5.1 Рефакторинг select_project_callback_query
- [ ] 5.1.1 Заменить `session[:add_time_project_id]` на `TelegramSession::AddTime`
- [ ] 5.1.2 Обновить сохранение в сессию

### 5.2 Рефакторинг add_time
- [ ] 5.2.1 Обновить чтение `project_id` через `telegram_session_data`
- [ ] 5.2.2 Добавить очистку сессии после успешного добавления

## Этап 6: Проверка других команд

### 6.1 Проверка команд в app/controllers/telegram/commands/
- [ ] 6.1.1 Проверить `add_command.rb` на использование сессий
- [ ] 6.1.2 Проверить `edit_command.rb` на использование сессий
- [ ] 6.1.3 Проверить `adduser_command.rb` на использование сессий
- [ ] 6.1.4 Проверить `new_command.rb` на использование сессий
- [ ] 6.1.5 Обновить все найденные использования старых ключей сессий

## Этап 7: Удаление устаревшего кода

### 7.1 Очистка старых ключей сессий
- [ ] 7.1.1 Найти все упоминания старых ключей (`:edit_*`, `:adduser_*`, `:add_time_*`)
- [ ] 7.1.2 Убедиться, что они больше не используются
- [ ] 7.1.3 Удалить все упоминания из кода

### 7.2 Обновление документации
- [ ] 7.2.1 Обновить `TODO.md` - отметить задачу как выполненную
- [ ] 7.2.2 Добавить комментарии в код о новой структуре сессий
- [ ] 7.2.3 Обновить `CLAUDE.md` с информацией о TelegramSession

## Этап 8: Финальное тестирование

### 8.1 Юнит-тесты
- [ ] 8.1.1 Запустить `bundle exec rspec spec/models/telegram_session*`
- [ ] 8.1.2 Убедиться, что все тесты проходят

### 8.2 Интеграционные тесты
- [ ] 8.2.1 Запустить `bundle exec rspec spec/controllers/concerns/telegram_callbacks_spec.rb`
- [ ] 8.2.2 Запустить `bundle exec rspec spec/controllers/telegram/`
- [ ] 8.2.3 Убедиться, что все тесты проходят

### 8.3 Ручное тестирование
- [ ] 8.3.1 Протестировать Edit flow в Telegram боте
- [ ] 8.3.2 Протестировать AddUser flow в Telegram боте
- [ ] 8.3.3 Протестировать AddTime flow в Telegram боте
- [ ] 8.3.4 Проверить отмену операций на всех этапах

### 8.4 Код-ревью и проверка качества
- [ ] 8.4.1 Запустить `bundle exec rubocop`
- [ ] 8.4.2 Исправить все замечания линтера
- [ ] 8.4.3 Запустить `bundle exec brakeman` для проверки безопасности

## Этап 9: Деплой

### 9.1 Подготовка к деплою
- [ ] 9.1.1 Создать PR с описанием изменений
- [ ] 9.1.2 Получить код-ревью
- [ ] 9.1.3 Убедиться, что CI проходит успешно

### 9.2 Деплой и мониторинг
- [ ] 9.2.1 Задеплоить на staging
- [ ] 9.2.2 Протестировать на staging
- [ ] 9.2.3 Задеплоить на production
- [ ] 9.2.4 Мониторить Bugsnag на наличие ошибок в течение 24 часов

---

## Статистика

**Общее количество задач:** 74

**Приоритет выполнения:**
1. Этапы 1-3: Базовая инфраструктура и самая сложная Edit сессия
2. Этапы 4-5: Остальные сессии (AddUser, AddTime)
3. Этапы 6-9: Очистка, тестирование и деплой

## Преимущества после рефакторинга

✅ Единая точка входа для работы с сессией
✅ Автоматическая очистка через единственный ключ
✅ Типобезопасность и валидация данных
✅ Легко тестировать
✅ Соблюдение принципов SOLID
✅ Масштабируемость для новых типов сессий
