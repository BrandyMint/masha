# План улучшения команды /add для Telegram бота

## Проблема

Пользователи часто путают местами slug проекта и время при использовании команды `/add`. Текущая реализация в `app/services/telegram_time_tracker.rb` использует простой алгоритм, который может ошибаться, особенно когда название проекта содержит цифры.

## Текущая реализация

**Файл**: `app/services/telegram_time_tracker.rb:32-42`

**Логика**:
1. Проверяет является ли первая часть сообщения числом → `hours project_slug`
2. Иначе проверяет вторую часть → `project_slug hours`
3. Если ни одна часть не число → ошибка

**Проблемы**:
- Неправильно определяет проекты с цифрами (`project123 2.5`)
- Нет обработки неоднозначных случаев
- Отсутствуют подсказки при ошибках

## План улучшения

### 1. Улучшенный алгоритм определения

**Новый метод**: `determine_hours_and_project(first_part, second_part)`

**Логика**:
1. **Получить контекст**: загружаем доступные проекты пользователя
2. **Проверка по slug проекта**: точное совпадение с доступными проектами
3. **Усиленная проверка времени**: строгий формат времени
4. **Эвристики для неоднозначных случаев**
5. **Возврат результата с уровнем уверенности**

### 2. Форматы и ограничения

**Формат времени**:
- `2.5`, `2,5`, `2`, `0.5`
- Диапазон: 0.1 - 24 часа
- Предупреждения для значений > 12 часов

**Формат slug проекта**:
- `[a-z0-9._+-]+` (из `app/models/project.rb:25`)
- Только доступные пользователю проекты
- Нечеткое сравнение для опечаток

### 3. Обработка неоднозначных случаев

**Сценарии**:
- Обе части могут быть временем → запрос уточнения
- Обе части похожи на проекты → предложение вариантов
- Ни одна часть не является ни временем ни проектом → подсказка с форматами

**Примеры сообщений**:
```
❓ Не понял. Вы имели в виду:
• 2.5 часа в проекте myproject?
• myproject 2.5 часа?

Выберите вариант или введите в формате: "2.5 project описание"
```

### 4. Улучшения UX

**Нечеткое сравнение**:
- Расстояние Левенштейна для опечаток
- Предложение исправлений: `"Возможно вы имели в виду 'myproject'?"`

**Подробные ошибки**:
- Показ доступных проектов
- Примеры правильного формата
- Подсказки по распространенным ошибкам

**Валидация времени**:
- Проверка реалистичности значения
- Предупреждения для необычных значений

### 5. Тестирование

**Кейсы для тестирования**:

| Вход | Ожидаемый результат | Описание |
|------|-------------------|----------|
| `2.5 myproject` | hours=2.5, project=myproject | Стандартный случай |
| `myproject 2.5` | hours=2.5, project=myproject | Обратный порядок |
| `project123 2.5` | hours=2.5, project=project123 | Проект с цифрами |
| `2.5 project123` | hours=2.5, project=project123 | Время + проект с цифрами |
| `2 2` | Запрос уточнения | Неоднозначность |
| `notaproject 2.5` | Ошибка + подсказка | Несуществующий проект |
| `25 myproject` | Предупреждение | Большое количество часов |
| `myproject 0.25` | hours=0.25, project=myproject | Дробные часы |

### 6. Структура кода

**Новые методы в `TelegramTimeTracker`**:

```ruby
def determine_hours_and_project(first_part, second_part)
  # Основной алгоритм определения
end

def time_format?(str)
  # Проверка формата времени с валидацией диапазона
end

def find_project_fuzzy(slug)
  # Поиск проекта с нечетким сравнением
end

def handle_ambiguous_result(first_part, second_part)
  # Обработка неоднозначных случаев
end

def available_projects_slugs
  # Кэширование доступных проектов
end
```

### 7. Реализация по шагам

1. **Рефакторинг текущего метода** `parse_time_tracking_message`
2. **Добавление нового алгоритма** `determine_hours_and_project`
3. **Реализация обработки неоднозначности**
4. **Добавление нечеткого поиска проектов**
5. **Валидация времени**
6. **Обновление сообщений об ошибках**
7. **Написание тестов**

### 8. Файлы для изменения

- **Основной**: `app/services/telegram_time_tracker.rb`
- **Тесты**: `spec/services/telegram_time_tracker_spec.rb` (если существует)
- **Документация**: обновить `/help` команду при необходимости

### 9. Метрики успеха

- ✅ Правильно определяет порядок в 95%+ случаев
- ✅ Обрабатывает проекты с цифрами
- ✅ Предлагает варианты при неоднозначности
- ✅ Снижает количество ошибок ввода
- ✅ Сохраняет обратную совместимость

---

**Автор**: Claude Code
**Дата**: 9 октября 2025
**Версия**: v1.0