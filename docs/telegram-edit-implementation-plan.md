# План имплементации команды /edit

## 1. Подготовка и анализ
- [ ] 1.1 Изучить существующие команды для понимания паттернов
- [x] 1.2 Проанализировать модель TimeShift и связанные модели
- [x] 1.3 Изучить TelegramHelpers и TelegramCallbacks
- [x] 1.4 Создать ТЗ документ

## 2. Создание базовой структуры команды
- [ ] 2.1 Создать файл `app/controllers/telegram/commands/edit_command.rb`
- [ ] 2.2 Реализовать базовый класс, наследующий от BaseCommand
- [ ] 2.3 Добавить команду в список доступных команд в webhook_controller.rb
- [ ] 2.4 Создать базовую структуру метода `call`

## 3. Реализация отображения списка записей
- [ ] 3.1 Создать метод для получения последних 50 записей пользователя
- [ ] 3.2 Реализовать форматирование списка записей
- [ ] 3.3 Добавить обработку случая отсутствия записей
- [ ] 3.4 Реализовать пагинацию или сокращенный формат для длинных описаний
- [ ] 3.5 Добавить валидацию прав доступа к записям

## 4. Реализация механизма выбора записи
- [ ] 4.1 Создать обработку ввода ID записи
- [ ] 4.2 Добавить валидацию формата ID (число)
- [ ] 4.3 Реализовать проверку существования записи
- [ ] 4.4 Добавить проверку прав доступа к конкретной записи
- [ ] 4.5 Создать сохранение выбранной записи в session

## 5. Создание интерфейса выбора поля редактирования
- [ ] 5.1 Реализовать inline кнопки для выбора поля
- [ ] 5.2 Создать callback обработчики для каждого поля
- [ ] 5.3 Добавить кнопку отмены операции
- [ ] 5.4 Реализовать сохранение выбранного поля в session
- [ ] 5.5 Добавить отображение текущего значения выбранного поля

## 6. Реализация редактирования проекта
- [ ] 6.1 Создать обработчик выбора нового проекта
- [ ] 6.2 Реализовать получение доступных проектов пользователя
- [ ] 6.3 Добавить валидацию существования проекта
- [ ] 6.4 Создать inline кнопки или текстовый ввод для проекта
- [ ] 6.5 Сохранить новое значение проекта в session

## 7. Реализация редактирования часов
- [ ] 7.1 Создать обработчик ввода новых часов
- [ ] 7.2 Добавить валидацию формата (число >= 0.1)
- [ ] 7.3 Реализовать проверку максимального значения (24 часа в день)
- [ ] 7.4 Добавить обработку дробных чисел (например, 1.5)
- [ ] 7.5 Сохранить новое значение часов в session

## 8. Реализация редактирования описания
- [ ] 8.1 Создать обработчик ввода нового описания
- [ ] 8.2 Добавить валидацию длины (до 1000 символов)
- [ ] 8.3 Реализовать поддержку пустого описания
- [ ] 8.4 Добавить обработку специальных символов
- [ ] 8.5 Сохранить новое описание в session

## 9. Создание сервиса редактирования
- [ ] 9.1 Создать файл `app/services/telegram_time_editor.rb`
- [ ] 9.2 Реализовать базовую структуру сервиса
- [ ] 9.3 Добавить метод для обновления записи в БД
- [ ] 9.4 Реализовать валидацию всех полей
- [ ] 9.5 Добавить транзакционность для безопасности

## 10. Реализация подтверждения изменений
- [ ] 10.1 Создать превью изменений (старые vs новые значения)
- [ ] 10.2 Реализовать inline кнопки "Сохранить" и "Отмена"
- [ ] 10.3 Добавить обработчик подтверждения сохранения
- [ ] 10.4 Создать обработчик отмены изменений
- [ ] 10.5 Реализовать очистку session после операции

## 11. Обработка ошибок и валидация
- [ ] 11.1 Добавить обработку неверного ID записи
- [ ] 11.2 Реализовать обработку отсутствия прав доступа
- [ ] 11.3 Создать обработку ошибок валидации данных
- [ ] 11.4 Добавить обработку таймаута сессии
- [ ] 11.5 Реализовать логирование ошибок в Bugsnag

## 12. Управление состоянием сессии
- [ ] 12.1 Создать структуру данных для edit_context в session
- [ ] 12.2 Реализовать сохранение состояния между шагами
- [ ] 12.3 Добавить очистку сессии при отмене/завершении
- [ ] 12.4 Создать обработку истечения времени сессии
- [ ] 12.5 Добавить возможность возврата к предыдущему шагу

## 13. Улучшение UX
- [ ] 13.1 Добавить кнопку "Назад" для возврата к выбору поля
- [ ] 13.2 Реализовать индикаторы текущего шага
- [ ] 13.3 Создать подсказки по формату данных
- [ ] 13.4 Добавить дружелюбные сообщения об ошибках
- [ ] 13.5 Реализовать таймаут неактивности (5 минут)

## 14. Интеграция с существующим функционалом
- [ ] 14.1 Обновить команду /help с описанием /edit
- [ ] 14.2 Добавить логирование операций редактирования
- [ ] 14.3 Интегрироваться с системой уведомлений
- [ ] 14.4 Обеспечить совместимость с существующими правами доступа
- [ ] 14.5 Проверить влияние на производительность

## 15. Тестирование
- [ ] 15.1 Создать unit тесты для EditCommand
- [ ] 15.2 Создать unit тесты для TelegramTimeEditor
- [ ] 15.3 Реализовать integration тесты полного сценария
- [ ] 15.4 Создать тесты обработки ошибок
- [ ] 15.5 Добавить тесты для валидации данных

## 16. Тестовые сценарии
- [ ] 16.1 Happy path: успешное редактирование проекта
- [ ] 16.2 Happy path: успешное редактирование часов
- [ ] 16.3 Happy path: успешное редактирование описания
- [ ] 16.4 Отмена на различных этапах процесса
- [ ] 16.5 Попытка редактирования чужой записи
- [ ] 16.6 Ввод некорректных данных
- [ ] 16.7 Таймаут сессии
- [ ] 16.8 Пустой список записей
- [ ] 16.9 Обработка очень длинных описаний

## 17. Финализация и деплой
- [ ] 17.1 Проверить покрытие тестов (>90%)
- [ ] 17.2 Протестировать вручную все сценарии
- [ ] 17.3 Обновить документацию
- [ ] 17.4 Проверить логирование ошибок
- [ ] 17.5 Подготовить к деплою

## 18. Пост-деплой мониторинг
- [ ] 18.1 Настроить мониторинг использования команды
- [ ] 18.2 Отслеживать ошибки через Bugsnag
- [ ] 18.3 Собрать обратную связь от пользователей
- [ ] 18.4 Оптимизировать производительность при необходимости
- [ ] 18.5 Запланировать улучшения на основе фидбэка