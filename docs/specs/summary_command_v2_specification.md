# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã `/summary` (v2.0)

## –û–±–∑–æ—Ä
–†–∞—Å—à–∏—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/summary` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–µ—Ä–∏–æ–¥–æ–≤: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞—Ç. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤) –≤—ã–≤–æ–¥–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `/summary` –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤—ã–≤–æ–¥–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É:

```
üìä *–ö–æ–º–∞–Ω–¥–∞ /summary - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º*

*–§–æ—Ä–º–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:*
‚Ä¢ `/summary day` - —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ `/summary week` - —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
‚Ä¢ `/summary month` - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
‚Ä¢ `/summary last_month` - –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
‚Ä¢ `/summary last_week` - –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è

*–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã:*
‚Ä¢ `/summary 2024-11-05` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞
‚Ä¢ `/summary 2024-11` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
‚Ä¢ `/summary 2024-11-01..2024-11-05` - –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
‚Ä¢ `/summary 2024-10..2024-11` - –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤

*–ü—Ä–∏–º–µ—Ä—ã:*
`/summary last_month` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
`/summary 2024-11-01..2024-11-07` - –∑–∞ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é –Ω–æ—è–±—Ä—è
`/summary 2024-10` - –∑–∞ –æ–∫—Ç—è–±—Ä—å 2024

_–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –ì–ì–ì–ì-–ú–ú-–î–î, —Ñ–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞: –ì–ì–ì–ì-–ú–ú_
```

### 2. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–µ—Ä–∏–æ–¥–æ–≤

#### –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:
- `day` - —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
- `week` - —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
- `month` - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
- `last_month` - –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
- `last_week` - –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è
- `last_day` - –≤—á–µ—Ä–∞

#### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:
- `2024-11-05` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞
- `2024-11-01..2024-11-05` - –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
- `2024-11` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
- `2024-11..2024-12` - –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤

### 3. –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–º–∞–Ω–¥—ã

```
/summary [–ø–µ—Ä–∏–æ–¥]
```

### 4. –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```
/summary                    # —Å–ø—Ä–∞–≤–∫–∞ (–Ω–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
/summary day               # —Å–µ–≥–æ–¥–Ω—è
/summary week              # —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
/summary month             # —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
/summary last_month        # –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
/summary last_week         # –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è
/summary 2024-11-05        # 5 –Ω–æ—è–±—Ä—è 2024
/summary 2024-11           # –Ω–æ—è–±—Ä—å 2024
/summary 2024-11-01..2024-11-05  # —Å 1 –ø–æ 5 –Ω–æ—è–±—Ä—è 2024
/summary 2024-10..2024-11  # –æ–∫—Ç—è–±—Ä—å-–Ω–æ—è–±—Ä—å 2024
```

### 5. –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞

–î–ª—è –≤—Å–µ—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –≤—ã–≤–æ–¥–∏—Ç—Å—è –º–∞—Ç—Ä–∏—Ü–∞ "–ø—Ä–æ–µ–∫—Ç—ã √ó –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" —Å –æ–±—â–∏–º–∏ —á–∞—Å–∞–º–∏ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –í –∑–∞–≥–æ–ª–æ–≤–∫–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥:

- "All days" - –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
- "2024-11-05 - 2024-11-01" - –¥–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç
- "November 2024" - –¥–ª—è –º–µ—Å—è—Ü–∞
- "Last week" - –¥–ª—è –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–∏

### 6. –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: `YYYY-MM-DD`
- –§–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞: `YYYY-MM`
- –î–∏–∞–ø–∞–∑–æ–Ω: `–¥–∞—Ç–∞1..–¥–∞—Ç–∞2` –∏–ª–∏ `–º–µ—Å—è—Ü1..–º–µ—Å—è—Ü2`
- –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ‚â§ –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: 365 –¥–Ω–µ–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö

### 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```
‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –ì–ì–ì–ì-–ú–ú-–î–î
‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–µ—Ä–∏–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: day, week, month, last_month, last_week
‚ùå –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –∫–æ–Ω–µ—á–Ω–æ–π
‚ùå –ü–µ—Ä–∏–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 365 –¥–Ω–µ–π
‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ —Å—Ç–∞—Ä—à–µ 2 –ª–µ—Ç
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ü–∞—Ä—Å–µ—Ä –ø–µ—Ä–∏–æ–¥–æ–≤

```ruby
class PeriodParser
  def self.parse(arg)
    case arg
    when 'day', 'week', 'month', 'last_month', 'last_week', 'last_day' then arg
    when /^\d{4}-\d{2}$/ then { type: :month, date: Date.parse("#{arg}-01") }
    when /^\d{4}-\d{2}-\d{2}$/ then { type: :date, date: Date.parse(arg) }
    when /^\d{4}-\d{2}-\d{2}\.\.\.\d{4}-\d{2}-\d{2}$/ then parse_date_range(arg)
    when /^\d{4}-\d{2}\.\.\.\d{4}-\d{2}$/ then parse_month_range(arg)
    else raise ArgumentError, "Invalid period format"
    end
  end

  private

  def self.parse_date_range(range_str)
    start_date, end_date = range_str.split('..').map { |d| Date.parse(d) }
    { type: :range, start_date: start_date, end_date: end_date }
  end

  def self.parse_month_range(range_str)
    start_month, end_month = range_str.split('..').map { |m| Date.parse("#{m}-01") }
    { type: :month_range, start_date: start_month, end_date: end_month }
  end
end
```

### 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è SummaryQuery

```ruby
class SummaryQuery
  def self.for_user(user, period: 'week')
    parsed_period = PeriodParser.parse(period)
    new(users: user.available_users,
        projects: user.available_projects,
        period: parsed_period)
  end

  private

  def build_period(period)
    case period
    when 'week' then (Date.today - 6)..Date.today
    when 'month' then Date.today.beginning_of_month..Date.today
    when 'last_month' then (Date.today - 1.month).beginning_of_month..(Date.today - 1.month).end_of_month
    when 'last_week' then (Date.today - 1.week).beginning_of_week..(Date.today - 1.week).end_of_week
    when 'last_day' then Date.today - 1.day
    when Hash then build_period_from_hash(period)
    else raise ArgumentError, "Unsupported period"
    end
  end

  def build_period_from_hash(period_hash)
    case period_hash[:type]
    when :date then period_hash[:date]..period_hash[:date]
    when :month then period_hash[:date].beginning_of_month..period_hash[:date].end_of_month
    when :range then period_hash[:start_date]..period_hash[:end_date]
    when :month_range then period_hash[:start_date]..period_hash[:end_date].end_of_month
    end
  end
end
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

```ruby
class SummaryCommand < BaseCommand
  HELP_TEXT = <<~TEXT
    üìä *–ö–æ–º–∞–Ω–¥–∞ /summary - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º*

    *–§–æ—Ä–º–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:*
    ‚Ä¢ `/summary day` - —Å–µ–≥–æ–¥–Ω—è
    ‚Ä¢ `/summary week` - —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
    ‚Ä¢ `/summary month` - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    ‚Ä¢ `/summary last_month` - –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
    ‚Ä¢ `/summary last_week` - –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è

    *–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã:*
    ‚Ä¢ `/summary 2024-11-05` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞
    ‚Ä¢ `/summary 2024-11` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
    ‚Ä¢ `/summary 2024-11-01..2024-11-05` - –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç
    ‚Ä¢ `/summary 2024-10..2024-11` - –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤

    *–ü—Ä–∏–º–µ—Ä—ã:*
    `/summary last_month` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
    `/summary 2024-11-01..2024-11-07` - –∑–∞ –ø–µ—Ä–≤—É—é –Ω–µ–¥–µ–ª—é –Ω–æ—è–±—Ä—è
    `/summary 2024-10` - –∑–∞ –æ–∫—Ç—è–±—Ä—å 2024

    _–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: –ì–ì–ì–ì-–ú–ú-–î–î, —Ñ–æ—Ä–º–∞—Ç –º–µ—Å—è—Ü–∞: –ì–ì–ì–ì-–ú–ú_
  TEXT

  def call(period = nil, *)
    if period.nil?
      respond_with :message, text: HELP_TEXT, parse_mode: :Markdown
      return
    end

    parsed_period = PeriodParser.parse(period)
    text = Reporter.new.projects_to_users_matrix(current_user, parsed_period)
    respond_with :message, text: code(text), parse_mode: :Markdown
  rescue ArgumentError => e
    respond_with :message, text: "‚ùå #{e.message}"
  end
end
```

## –¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏

### –£—Å–ø–µ—à–Ω—ã–µ:
- `/summary` ‚Üí —Å–ø—Ä–∞–≤–∫–∞
- `/summary last_month` ‚Üí –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
- `/summary 2024-11` ‚Üí –Ω–æ—è–±—Ä—å 2024
- `/summary 2024-11-01..2024-11-05` ‚Üí 5 –¥–Ω–µ–π –Ω–æ—è–±—Ä—è

### –û—à–∏–±–∫–∏:
- `/summary 2024-13-01` ‚Üí –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è –¥–∞—Ç–∞
- `/summary 2024-11-05..2024-11-01` ‚Üí –Ω–∞—á–∞–ª–æ –ø–æ–∑–∂–µ –∫–æ–Ω—Ü–∞
- `/summary 2020-01` ‚Üí –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 2 –ª–µ—Ç
```
TodoWrite
<arg_key>todos</arg_key>
<arg_value>[{"content": "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã /summary —Å help –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", "status": "completed", "activeForm": "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ /summary"}, {"content": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é .protocols/", "status": "completed", "activeForm": "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏"}]