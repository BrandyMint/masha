# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Transactional Fixtures

üìÖ **–î–∞—Ç–∞**: 10 –Ω–æ—è–±—Ä—è 2025
üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å–ø–µ—à–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

## ‚úÖ –£—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DatabaseCleaner
- **–£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** –º–µ–∂–¥—É transactional fixtures –∏ DatabaseCleaner
- **–û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤** (JS, system)
- **–ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ** transactional fixtures

### 2. –°–æ–∑–¥–∞–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ fixtures
- **6 YAML fixtures** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏:
  - `users.yml` - —Å `crypted_password` (Sorcery)
  - `memberships.yml` - —Å `role_cd` (enum)
  - `telegram_users.yml`, `projects.yml`, `clients.yml`, `time_shifts.yml`

### 3. Shared Context –æ–±–Ω–æ–≤–ª–µ–Ω
- **–ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç**: `telegram_webhook_with_fixtures`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç fixtures –≤–º–µ—Å—Ç–æ factories**
- **–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–π**

### 4. –†–∞–±–æ—á–∏–µ —Ç–µ—Å—Ç—ã
- **14 –∏–∑ 17 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç** (82% —É—Å–ø–µ—Ö–∞)
- **–ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç** —Å fixtures
- **Telegram webhook —Ç–µ—Å—Ç—ã** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –†–∞–±–æ—á–∏–µ —Ç–µ—Å—Ç—ã (14/17):
1. ‚úÖ responds to /projects command without errors
2. ‚úÖ displays projects header
3. ‚úÖ lists available projects from fixtures
4. ‚úÖ formats projects with bullet points
5. ‚úÖ displays only projects where user is member
6. ‚úÖ displays projects where user is viewer
7. ‚úÖ displays all owned projects
8. ‚úÖ displays active projects only
9. ‚úÖ displays all accessible projects regardless of role
10. ‚úÖ responds with empty projects message (unauthenticated)
11. ‚úÖ displays only active (non-archived) projects
12. ‚úÖ handles very long project names gracefully
13. ‚úÖ mixed project access scenarios
14. ‚úÖ edge cases with dynamic data

### ‚ö†Ô∏è –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (3/17):
1. **create(:user)** –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
2. **Helper –º–µ—Ç–æ–¥—ã** —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏
3. **–°–ª–æ–∂–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏

### ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞:
- **Transactional fixtures —Ä–∞–±–æ—Ç–∞—é—Ç**
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ**
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å DatabaseCleaner —Ä–µ—à–µ–Ω**
- **Infrastructure –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤–∞**

### üìà –ò–∑–º–µ—Ä–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~0.7-1.0s (–±—ã—Å—Ç—Ä–æ –¥–ª—è telegram —Ç–µ—Å—Ç–æ–≤)
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: 82% —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîß –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. DatabaseCleaner –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```ruby
# –ë—ã–ª–æ: –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å transactional fixtures
config.before(:each) do
  DatabaseCleaner.start
end

# –°—Ç–∞–ª–æ: —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
config.before(:each, :js => true) do
  DatabaseCleaner.strategy = :truncation
end
```

### 2. Fixtures —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
```yaml
# –ë—ã–ª–æ (–Ω–µ–≤–µ—Ä–Ω–æ):
role: owner

# –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
role_cd: 0  # enum –∑–Ω–∞—á–µ–Ω–∏–µ
```

### 3. Shared Context —Å fixtures
```ruby
# –ë—ã–ª–æ:
let(:user) { create(:user, :with_telegram) }

# –°—Ç–∞–ª–æ:
let(:user) { users(:user_with_telegram) }
```

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å create() –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã** - –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–π
2. **–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å helper –º–µ—Ç–æ–¥—ã** - –∏—Å–ø—Ä–∞–≤–∏—Ç—å `role_cd` –∏ –¥—Ä—É–≥–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã
3. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ telegram —Ç–µ—Å—Ç—ã** - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. **–°–æ–∑–¥–∞—Ç—å performance —Ç–µ—Å—Ç—ã** - –∑–∞–º–µ—Ä–∏—Ç—å —É—Å–∫–æ—Ä–µ–Ω–∏–µ
2. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –æ–±–Ω–æ–≤–∏—Ç—å –≥–∞–π–¥—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
3. **–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞ fixtures

## üöÄ –ü–ª–∞–Ω –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞

### –§–∞–∑–∞ 1: –†–µ—à–µ–Ω–∏–µ create() –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –û—Ç–∫–ª—é—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sequence –≤ fixtures
- –ò–ª–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—ã

### –§–∞–∑–∞ 2: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫–æ –≤—Å–µ–º 19 telegram —Ç–µ—Å—Ç–∞–º
- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å model —Ç–µ—Å—Ç—ã (–ø—Ä–æ—Å—Ç—ã–µ)
- –û–±–Ω–æ–≤–∏—Ç—å service —Ç–µ—Å—Ç—ã

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ factories
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å helper –º–µ—Ç–æ–¥—ã
- –°–æ–∑–¥–∞—Ç—å performance benchmark

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: 30-50% –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: 100% —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç
- **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ static/dynamic –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä—ã–π feedback loop

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã, –º–∏–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é**