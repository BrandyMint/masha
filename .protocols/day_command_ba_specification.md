# Бизнес-спецификация: Команда `/day` для Telegram бота Masha

**Автор:** Бизнес-аналитик
**Дата создания:** 2025-10-21
**Версия:** 1.0

## 1. Общее описание

**Команда `/day`** - команда Telegram бота для получения ежедневного отчета по отработанному времени в разрезе проектов. Команда показывает пользователю все записи времени за текущий день, сгруппированные по проектам с итоговыми значениями.

## 2. Цели и задачи

### Бизнес-цели:
- Повышение осведомленности пользователей о распределении времени по проектам в течение дня
- Упрощение ежедневного трекинга и контроля рабочего времени
- Сокращение времени на получение сводной информации о дневной активности

### Задачи:
- Предоставить быстрый доступ к информации о времени, отмеченном за текущий день
- Сгруппировать данные по проектам для удобного анализа
- Показать общее количество часов за день
- Обеспечить интеграцию с существующей системой ролей и прав доступа

## 3. Пользовательские истории

### Основные сценарии использования:

**Как пользователь я хочу:**
- Видеть все свои записи времени за сегодня, сгруппированные по проектам
- Быстро понимать, сколько часов я потратил на каждый проект
- Видеть общее количество отработанных часов за день
- Получать уведомление, если за сегодня еще нет записей времени

**Как менеджер проекта я хочу:**
- Проверять свою дневную активность по разным проектам
- Контролировать распределение времени в течение дня

## 4. Функциональные требования

### 4.1. Основная функциональность

#### FR1: Отображение дневного отчета
- **FR1.1**: Команда `/day` показывает все записи времени пользователя за текущую дату
- **FR1.2**: Данные группируются по проектам
- **FR1.3**: Для каждого проекта показывается:
  - Название проекта (slug)
  - Общее количество часов по проекту за день
  - Список всех записей с описаниями
- **FR1.4**: Показывается общее количество часов за день по всем проектам

#### FR2: Форматирование вывода
- **FR2.1**: Используется табличный формат (аналогично команде `/hours`)
- **FR2.2**: Таблица содержит колонки: Проект, Часы, Описание
- **FR2.3**: Итоговая строка с общим количеством часов
- **FR2.4**: Выравнивание числовых значений по правому краю

#### FR3: Обработка пустых данных
- **FR3.1**: Если за текущий день нет записей, выводится соответствующее сообщение
- **FR3.2**: Предлагается добавить время с помощью команды `/add`

### 4.2. Дополнительная функциональность

#### FR4: Фильтрация по проекту
- **FR4.1**: Команда поддерживает опциональный параметр: `/day [project_key]`
- **FR4.2**: При указании проекта показываются только записи по этому проекту
- **FR4.3**: Используется тот же механизм поиска проектов, что в других командах

#### FR5: Обработка ошибок
- **FR5.1**: Обработка несуществующего проекта аналогично другим командам
- **FR5.2**: Предложение списка доступных проектов при ошибке

## 5. Нефункциональные требования

### 5.1. Производительность
- **NFR1**: Время отклика команды не более 2 секунд
- **NFR2**: Оптимизация запросов к БД (use includes для preload проектов)

### 5.2. Usability
- **NFR3**: Интуитивно понятный формат вывода
- **NFR4**: Соответствие стилю других команд бота
- **NFR5**: Локализация на русский язык

### 5.3. Надежность
- **NFR6**: Корректная обработка пограничных случаев (пустые данные, ошибки)
- **NFR7**: Соблюдение прав доступа пользователя

## 6. Технические требования

### 6.1. Архитектура
- **TR1**: Создать новый класс `DayCommand` в `app/controllers/telegram/commands/`
- **TR2**: Использовать существующий паттерн команд с наследованием от `BaseCommand`
- **TR3**: Использовать существующий механизм поиска проектов
- **TR4**: Применить `Terminal::Table` для форматирования

### 6.2. Интеграция с существующей системой
- **TR5**: Использовать модель `TimeShift` и существующие scope
- **TR6**: Применить фильтрацию по доступным проектам пользователя
- **TR7**: Использовать валидацию и обработку ошибок из других команд
- **TR8**: Соблюдать форматирование `code()` для Markdown

### 6.3. Логика данных
- **TR9**: Фильтр записей по полю `date = CURRENT_DATE`
- **TR10**: Группировка по `project_id`
- **TR11**: Сортировка по дате descending (для последовательности в течение дня)

## 7. Сценарии использования

### 7.1. Основной сценарий
```
Пользователь: /day
Бот: [Таблица с дневными записями по всем проектам]
```

### 7.2. Сценарий с фильтрацией
```
Пользователь: /day project-x
Бот: [Таблица с дневными записями по проекту project-x]
```

### 7.3. Сценарий без данных
```
Пользователь: /day
Бот: "За сегодня еще нет записей времени. Добавьте время с помощью команды /add"
```

### 7.4. Сценарий ошибки
```
Пользователь: /day unknown-project
Бот: "Не найден проект 'unknown-project'. Доступные проекты: project-a, project-b"
```

## 8. План тестирования

### 8.1. Unit тесты
- Тестирование метода `call()` с различными параметрами
- Тестирование фильтрации по проекту
- Тестирование обработки пустых данных
- Тестирование форматирования таблицы

### 8.2. Интеграционные тесты
- Проверка корректности данных из БД
- Проверка прав доступа
- Тестирование с различными наборами данных

### 8.3. RSpec тесты
- Спецификация для `DayCommand`
- Тесты для методов форматирования
- Тесты обработки ошибок

## 9. Критерии приемки

**Функциональность:**
- [ ] Команда `/day` показывает записи за текущий день
- [ ] Данные корректно группируются по проектам
- [ ] Общее количество часов рассчитывается верно
- [ ] Форматирование соответствует ожиданиям

**Интеграция:**
- [ ] Команда интегрирована в список доступных команд
- [ ] Используются существующие механизмы поиска проектов
- [ ] Соблюдаются права доступа

**Качество:**
- [ ] Написаны и проходят все тесты
- [ ] Код соответствует style guide (RuboCop)
- [ ] Обработаны все edge cases

## 10. Риски и митигация

**Риски:**
- Проблемы с определением "текущего дня" для пользователей в разных часовых поясах
- Нагрузка на БД при большом количестве записей

**Митигация:**
- Использовать временную зону пользователя или UTC
- Оптимизировать запросы и использовать кэширование при необходимости

## 11. Будущие улучшения

- Возможность просмотра отчета за другие дни (`/day YYYY-MM-DD`)
- Экспорт дневного отчета в других форматах
- Графическое представление дневной активности
- Интеграция с календарем и планировщиком