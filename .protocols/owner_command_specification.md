# Бизнес-спецификация: Команда `/owner` для Telegram бота Masha

**Автор:** Бизнес-аналитик
**Дата создания:** 2025-10-22
**Версия:** 1.0

## 1. Общее описание

**Команда `/owner`** - административная команда Telegram бота для просмотра и смены владельца проекта. Команда доступна только разработчику системы (пользователь с telegram_id указанным в `developer_telegram_id`) и предоставляет полный контроль над структурой владения проектами.

## 2. Цели и задачи

### Бизнес-цели:
- Обеспечение контроля над структурой владения проектами в системе
- Предоставление механизма для исправления ошибок владения проектами
- Поддержание целостности системы доступа и прав пользователей

### Задачи:
- Предоставить разработчику информацию о текущих владельцах всех проектов
- Обеспечить безопасную передачу прав владения между пользователями
- Предотвратить ситуации, когда проект остается без владельца
- Обеспечить аудит операций смены владельца

## 3. Пользовательские истории

### Основные сценарии использования:

**Как разработчик я хочу:**
- Видеть список всех проектов и их текущих владельцев
- Быстро понимать, у каких проектов нет владельца
- Менять владельца проекта на другого существующего пользователя
- Получать подтверждение успешной операции смены владельца
- Иметь возможность откатить некорректные изменения

**Как администратор системы я хочу:**
- Контролировать структуру владения проектами
- Выполнять массовые операции по смене владельцев при необходимости
- Иметь полный лог всех операций смены владельца

## 4. Функциональные требования

### 4.1. Основная функциональность

#### FR1: Отображение владельцев проектов
- **FR1.1**: Команда `/owner` без параметров показывает список всех проектов системы
- **FR1.2**: Для каждого проекта отображается:
  - Название проекта (name)
  - Slug проекта
  - Текущий владелец (имя, email, telegram username)
  - Статус проекта (активный/архивный)
- **FR1.3**: Проекты без владельца помечаются специальным маркером
- **FR1.4**: Используется табличный формат для удобного восприятия

#### FR2: Смена владельца проекта
- **FR2.1**: Команда `/owner` поддерживает смену владельца: `/owner {project_slug} {new_owner_identifier}`
- **FR2.2**: В качестве идентификатора нового владельца может использоваться:
  - Email пользователя
  - Telegram username (с @ или без)
  - ID пользователя
- **FR2.3**: Перед сменой владельца выполняется валидация:
  - Проект существует
  - Новый владелец существует в системе
  - Новый владелец не является текущим владельцем
- **FR2.4**: Смена владельца выполняется транзакционно с обновлением membership
- **FR2.5**: Старый владелец автоматически получает роль "watcher" в проекте

#### FR3: Подтверждение и откат операций
- **FR3.1**: После успешной смены владельца выводится подтверждение
- **FR3.2**: В подтверждении указывается старый и новый владелец
- **FR3.3**: Операция логируется в системе аудита
- **FR3.4**: Предоставляется информация для отката (если потребуется)

### 4.2. Обработка ошибок и валидация

#### FR4: Обработка некорректных данных
- **FR4.1**: Несуществующий проект - предложение списка доступных проектов
- **FR4.2**: Несуществующий пользователь - сообщение об ошибке с подсказкой
- **FR4.3**: Неправильный формат команды -显示 помощи по использованию
- **FR4.4**: Попытка сделать пользователя владельцем его же проекта

#### FR5: Проверка прав доступа
- **FR5.1**: Команда доступна только разработчику системы
- **FR5.2**: При попытке использования другим пользователем выводится сообщение об отказе в доступе

### 4.3. Дополнительная функциональность

#### FR6: Поиск и фильтрация
- **FR6.1**: Возможность фильтрации проектов по статусу: `/owner active` или `/owner archived`
- **FR6.2**: Поиск проектов по части названия: `/owner search {pattern}`
- **FR6.3**: Показ проектов без владельца: `/owner orphaned`

#### FR7: Массовые операции
- **FR7.1**: Просмотр статистики по владельцам проектов
- **FR7.2**: Выявление пользователей с большим количеством проектов

## 5. Нефункциональные требования

### 5.1. Безопасность
- **NFR1**: Строгое ограничение доступа - только разработчик
- **NFR2**: Логирование всех операций смены владельца
- **NFR3**: Валидация всех входных данных
- **NFR4**: Защита от CSRF и инъекций

### 5.2. Производительность
- **NFR5**: Время отклика команды не более 3 секунд
- **NFR6**: Оптимизация запросов к БД (preload связанных данных)
- **NFR7**: Эффективная обработка списков проектов

### 5.3. Usability
- **NFR8**: Понятный и последовательный интерфейс
- **NFR9**: Информативные сообщения об ошибках
- **NFR10**: Подсказки по использованию команды
- **NFR11**: Локализация на русский язык

### 5.4. Надежность
- **NFR12**: Транзакционная целостность операций
- **NFR13**: Корректная обработка исключительных ситуаций
- **NFR14**: Сохранение консистентности данных

## 6. Технические требования

### 6.1. Архитектура
- **TR1**: Создать новый класс `OwnerCommand` в `app/controllers/telegram/commands/`
- **TR2**: Использовать существующий паттерн команд с наследованием от `BaseCommand`
- **TR3**: Применить `Terminal::Table` для форматирования вывода
- **TR4**: Использовать существующие валидаторы и хелперы

### 6.2. Работа с данными
- **TR5**: Использовать модели `Project`, `User`, `Membership`, `TelegramUser`
- **TR6**: Применять существующие scope для фильтрации проектов
- **TR7**: Использовать механизм `Membership` для управления ролями
- **TR8**: Обеспечить transactional обновление данных

### 6.3. Интеграция с существующей системой
- **TR9**: Использовать `developer?` метод для проверки прав доступа
- **TR10**: Применить существующие механизмы поиска пользователей
- **TR11**: Следовать паттернам форматирования и обработки ошибок
- **TR12**: Интегрироваться с существующими системами логирования

### 6.4. Форматирование и вывод
- **TR13**: Табличный вывод с выравниванием колонок
- **TR14**: Markdown форматирование для улучшения читаемости
- **TR15**: Цветовое выделение (если поддерживается)
- **TR16**: Пагинация для больших списков (если необходимо)

## 7. Сценарии использования

### 7.1. Основной сценарий - просмотр владельцев
```
Разработчик: /owner
Бот: [Таблица со всеми проектами и их владельцами]
```

### 7.2. Сценарий смены владельца
```
Разработчик: /owner project-x newuser@example.com
Бот: "Владелец проекта 'project-x' изменен с 'olduser@example.com' на 'newuser@example.com'. Старый владелец теперь имеет роль 'watcher'."
```

### 7.3. Сценарий с использованием Telegram username
```
Разработчик: /owner my-project @username
Бот: "Владелец проекта 'my-project' изменен на '@username' (user@example.com)."
```

### 7.4. Сценарий ошибки - проект не найден
```
Разработчик: /owner unknown-project user@example.com
Бот: "Проект 'unknown-project' не найден. Доступные проекты: project-a, project-b, project-c"
```

### 7.5. Сценарий ошибки - пользователь не найден
```
Разработчик: /owner project-x unknown@example.com
Бот: "Пользователь 'unknown@example.com' не найден в системе. Проверьте email или используйте Telegram username."
```

### 7.6. Сценарий фильтрации проектов
```
Разработчик: /owner active
Бот: [Таблица только с активными проектами]
```

### 7.7. Сценарий поиска проектов без владельца
```
Разработчик: /owner orphaned
Бот: "Найдено 3 проекта без владельца: project-a, project-b, project-c"
```

### 7.8. Сценарий отказа в доступе
```
Пользователь: /owner
Бот: "Эта команда доступна только разработчику системы"
```

## 8. План тестирования

### 8.1. Unit тесты
- Тестирование метода `call()` с различными параметрами
- Тестирование логики смены владельца
- Тестирование валидации входных данных
- Тестирование форматирования таблиц
- Тестирование обработки ошибок

### 8.2. Интеграционные тесты
- Проверка корректности обновления membership
- Тестирование транзакционной целостности
- Проверка логирования операций
- Тестирование прав доступа

### 8.3. RSpec тесты
- Спецификация для `OwnerCommand`
- Тесты для различных сценариев использования
- Тесты edge cases и граничных условий
- Тесты производительности

### 8.4. Тесты безопасности
- Проверка ограничения доступа
- Тестирование валидации входных данных
- Проверка защиты от инъекций

## 9. Критерии приемки

**Функциональность:**
- [ ] Команда `/owner` показывает список всех проектов и владельцев
- [ ] Команда корректно меняет владельца проекта
- [ ] Обрабатываются все сценарии ошибок
- [ ] Поддерживаются различные форматы идентификации пользователей
- [ ] Операции логируются в системе

**Интеграция:**
- [ ] Команда доступна только разработчику
- [ ] Используются существующие механизмы поиска и валидации
- [ ] Соблюдаются паттерны форматирования вывода
- [ ] Интеграция с системой membership работает корректно

**Качество:**
- [ ] Написаны и проходят все тесты
- [ ] Код соответствует style guide (RuboCop)
- [ ] Покрытие кода тестами не менее 90%
- [ ] Обработаны все edge cases

**Безопасность:**
- [ ] Ограничен доступ к команде
- [ ] Валидируются все входные данные
- [ ] Логируются все операции
- [ ] Обеспечена целостность данных

## 10. Риски и митигация

**Риски:**
- Случайная передача прав неправильному пользователю
- Потеря данных при ошибках в процессе смены владельца
- Производительность при большом количестве проектов
- Проблемы с идентификацией пользователей

**Митигация:**
- Двойное подтверждение при смене владельца
- Использование транзакций и rollback при ошибках
- Оптимизация запросов и пагинация
- Поддержка множества форматов идентификации
- Детальное логирование для возможности отката

## 11. Будущие улучшения

- Веб-интерфейс для управления владельцами проектов
- Массовые операции по смене владельцев
- История изменений владельцев проектов
- Уведомления пользователей о смене владельца
- Интеграция с системами аудита и мониторинга
- Возможность временной передачи прав владения
- Поддержка множественных владельцев проектов