# План миграции команды adduser в подкоманду users

## Обзор
Миграция команды `/adduser` в подкоманду `/users add` для консолидации функционала управления пользователями.

## Статус: ✅ ЗАВЕРШЕНО

## Изменения

### 1. Модификация UsersCommand (`app/commands/users_command.rb`)
- **ДО**: Только список пользователей проекта
- **ПОСЛЕ**: Полная поддержка подкоманд:
  - `/users` - показать пользователей проекта
  - `/users all` - показать всех пользователей (для разработчика)
  - `/users add {project} {username} [role]` - добавить пользователя
  - `/users remove {project} {username}` - удалить пользователя (не реализовано)
  - `/users help` - показать справку

**Ключевые изменения:**
- Изменена сигнатура метода `call(action = nil, *args)`
- Добавлены context методы: `users_add_project`, `users_add_username_input`
- Добавлены callback обработчики: `users_add_project_callback_query`, `users_add_role_callback_query`, `users_list_project_callback_query`
- Полностью сохранена функциональность из AdduserCommand

### 2. Обновление TelegramSession (`app/models/telegram_session.rb`)
- Добавлен новый тип сессии: `users_add_user`
- Добавлен factory метод: `users_add_user(project_slug:)`

### 3. Создание обертки AdduserCommand (`app/commands/adduser_command.rb`)
- **ДО**: Полнофункциональная команда
- **ПОСЛЕ**: Обертка с предупреждением об устаревании
- Показывает предупреждение: "⚠️ Команда /adduser устарела. Используйте /users add вместо неё."
- Делегирует выполнение в `UsersCommand.new(controller).call('add', ...)`
- Сохраняет полную обратную совместимость

### 4. Обновление HelpCommand (`app/commands/help_command.rb`)
- **ДО**: `/adduser {project_slug} {username} [role] - Добавить пользователя в проект`
- **ПОСЛЕ**: `/users add {project_slug} {username} [role] - Добавить пользователя в проект`
- Добавлена developer секция с командой `/users`

### 5. Обновление тестов
- **AdduserCommand tests**: Обновлены для проверки предупреждения об устаревании
- **UsersCommand tests**: Созданы новые тесты для всех подкоманд
- **Исправления фикстур**: Добавлены отсутствующие пользователи в `users.yml` и `telegram_users.yml`

## Обратная совместимость

✅ **Полностью сохранена**:
- Старая команда `/adduser` продолжает работать
- Все существующие workflow функционируют
- Показывается предупреждение о переходе на новый синтаксис
- Результат выполнения идентичен прежнему

## Тестирование

✅ **Все тесты проходят**:
- `adduser_command_spec.rb`: 22 examples, 0 failures
- `users_command_spec.rb`: 19 examples, 0 failures
- `help_command_spec.rb`: 1 example, 0 failures

## Результат миграции

1. **Консолидация**: Весь функционал управления пользователями теперь в команде `/users`
2. **Интуитивность**: Новая структура более логична и расширяема
3. **Обратная совместимость**: Старые пользователи не затронуты
4. **Будущее развитие**: Легко добавлять новые подкоманды (например, `/users list`, `/users remove`)

## Следующие шаги (опционально)

1. Реализовать функцию `/users remove`
2. Добавить `/users list` для явного указания списка пользователей
3. Добавить валидацию параметров в UsersCommand
4. Обновить документацию для пользователей

## Время выполнения
~2 часа на миграцию + тестирование + исправление проблем