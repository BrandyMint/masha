# План имплементации команды /client

## Обзор
План имплементации функционала управления клиентами (компаниями) в Telegram-боте Masha на основе спецификации из `client_command_specification.md`.

## Этапы имплементации

### 1. База данных и модели

- [ ] 1.1 Миграция для модели Client
- [ ] 1.2 Модель Client с валидациями и связями
- [ ] 1.3 Обновление существующих моделей (User, Project)

### 2. Система прав доступа

- [ ] 2.1 Авторайзер ClientAuthorizer

### 3. Telegram-бот интеграция

- [ ] 3.1 Локализации для команды /client
- [ ] 3.2 Основная команда /client (просмотр списка)
- [ ] 3.3 Подкоманда /client add (создание компании)
- [ ] 3.4 Подкоманда /client show {key} (детальная информация)
- [ ] 3.5 Подкоманда /client edit {key} (редактирование)
- [ ] 3.6 Подкоманда /client delete {key} (удаление)
- [ ] 3.7 Подкоманда /client projects {key} (проекты компании)
- [ ] 3.8 Подкоманда /client attach {key} (присоединение проекта)
- [ ] 3.9 Подкоманда /client detach {key} (отсоединение проекта)
- [ ] 3.10 Подкоманда /client help (справка)

### 4. Обновление существующего функционала

- [ ] 4.1 Отображение проектов с привязанными компаниями

### 5. Тестирование

- [ ] 5.1 Модельные тесты для Client
- [ ] 5.2 Тесты авторайзера ClientAuthorizer
- [ ] 5.3 Интеграционные тесты Telegram-бот команды

## Детальная реализация

### 1. База данных и модели

#### 1.1 Миграция для модели Client
- Создать таблицу `clients` со следующими полями:
  - `key: string` (уникальный в рамках пользователя)
  - `name: string` (юридическое наименование)
  - `user_id: bigint` (внешний ключ на владельца)
  - Индексы: `user_id`, `key` (композитный уникальный индекс на `user_id` + `key`)

#### 1.2 Модель Client
```ruby
class Client < ApplicationRecord
  belongs_to :user
  has_many :projects, dependent: :nullify

  validates :key, presence: true, uniqueness: { scope: :user_id },
                 format: { with: /\A[a-z0-9_-]+\z/ },
                 length: { minimum: 2, maximum: 50 }
  validates :name, presence: true, length: { maximum: 255 }
end
```

#### 1.3 Обновление существующих моделей
- **User**: `has_many :clients, dependent: :destroy`
- **Project**: `belongs_to :client, optional: true`

### 2. Система прав доступа

#### 2.1 Авторайзер ClientAuthorizer
- Создание правил доступа на основе спецификации
- Владелец компании: полный доступ
- Участники проектов компании: просмотр

### 3. Telegram-бот интеграция

#### 3.1 Локализации
- Добавить все текстовые сообщения в `config/locales/ru.yml`
- Включить сообщения об ошибках, подсказки, форматы вывода

#### 3.2 Команда /client
- Основной обработчик для отображения списка компаний пользователя
- Формат вывода: key, название, количество проектов

#### 3.3-3.10 Подкоманды
- `/client add` - интерактивное создание компании
- `/client show {key}` - детальная информация о компании
- `/client edit {key}` - редактирование данных компании
- `/client delete {key}` - удаление компании с проверками
- `/client projects {key}` - список проектов компании
- `/client attach {key}` - присоединение проекта к компании
- `/client detach {key}` - отсоединение проекта от компании
- `/client help` - справка по команде

### 4. Обновление существующего функционала

#### 4.1 Отображение проектов
- Обновить вывод списка проектов для показа привязанных компаний
- Формат: `Название проекта (Название компании)`

### 5. Тестирование

#### 5.1 Модельные тесты
- Валидации модели Client
- Связи между моделями
- Бизнес-логика

#### 5.2 Тесты авторайзера
- Проверка прав доступа для всех ролей
- Негативные сценарии доступа

#### 5.3 Интеграционные тесты
- Тестирование всех сценариев использования Telegram-бота
- Проверка обработки ошибок

## Порядок выполнения

1. **Подготовка данных** (пункты 1.1-1.3)
   - Миграция базы данных
   - Создание модели Client
   - Обновление связей в User и Project

2. **Бизнес-логика** (пункт 2.1)
   - Авторайзер для управления доступом
   - Сервисные объекты для сложных операций

3. **Пользовательский интерфейс** (пункты 3.1-3.10)
   - Локализации
   - Реализация команды /client и подкоманд
   - Обновление отображения проектов

4. **Тестирование** (пункты 5.1-5.3)
   - Модельные тесты
   - Тесты авторайзера
   - Интеграционные тесты Telegram-бота

## Технические детали

### Валидация key
- Формат: `[a-z0-9_-]+`
- Уникальность в рамках пользователя
- Длина: 2-50 символов

### Права доступа
- Создание: любой пользователь
- Просмотр: владелец + участники проектов
- Редактирование: только владелец
- Удаление: только владелец (с проверкой на связанные проекты)

### Интеграция с проектами
- Связь через `belongs_to :client`
- Каскадное обновление при удалении компании
- Отображение в списках проектов

## Риски и митигация

1. **Удаление компании с проектами**
   - Решение: Зависимость `dependent: :nullify` + дополнительные проверки

2. **Уникальность ключей**
   - Решение: Композитный индекс и валидация на уровне модели

3. **Производительность**
   - Решение: Оптимизация запросов, eager loading связанных данных

## Критерии готовности

- ✅ Все команды работают согласно спецификации
- ✅ Валидация данных корректна
- ✅ Права доступа работают правильно
- ✅ Обработка ошибочных ситуаций
- ✅ Тесты покрывают все сценарии
- ✅ Интеграция с существующей системой проектов