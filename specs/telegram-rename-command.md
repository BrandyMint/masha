# Спецификация команды /rename для Telegram бота

## Обзор

Команда `/rename` позволяет переименовать проект через Telegram бота. Команда поддерживает два режима использования:
1. С указанием slug проекта - прямое переименование
2. Без аргументов - выбор проекта из списка с кнопками

## Требования к доступу

- Пользователь должен быть аутентифицирован в системе
- Команда доступна только в личных сообщениях с ботом
- Пользователь должен иметь роль "owner" (владелец) в проекте для переименования

## Паттерны использования

### Сценарий 1: Прямое переименование с указанием slug

```
/rename project-slug "Новое название проекта"
```

**Алгоритм:**
1. Парсинг аргументов: `[project_slug, new_name]`
2. Поиск проекта по slug среди доступных пользователю
3. Проверка прав доступа (роль owner)
4. Валидация нового названия
5. Обновление названия проекта
6. Автоматическое обновление slug (friendly_id)
7. Отправка подтверждения

### Сценарий 2: Выбор проекта из списка

```
/rename
```

**Алгоритм:**
1. Отображение списка проектов пользователя с кнопками
2. Пользователь выбирает проект через inline keyboard
3. Запрос ввода нового названия
4. Валидация и сохранение нового названия
5. Автоматическое обновление slug
6. Отправка подтверждения

## Детальная реализация

### 1. Основной класс команды

**Файл:** `app/controllers/telegram/commands/rename_command.rb`

```ruby
module Telegram
  module Commands
    class RenameCommand < BaseCommand
      def call(project_slug = nil, *name_parts)
        if project_slug.present?
          # Прямое переименование
          new_name = name_parts.join(' ')
          rename_project_directly(project_slug, new_name)
        else
          # Показать список проектов для выбора
          show_projects_selection
        end
      end

      private

      def rename_project_directly(project_slug, new_name)
        # Реализация прямого переименования
      end

      def show_projects_selection
        # Показ списка проектов с кнопками
      end
    end
  end
end
```

### 2. Callback обработчики

**Файл:** `app/controllers/concerns/telegram_callbacks.rb`

```ruby
# Выбор проекта для переименования
def rename_project_callback_query(project_slug)
  project = find_project(project_slug)
  # Проверка прав и сохранение в сессию
  save_context :rename_new_name_input
  edit_message :text, text: "Проект: #{project.name}\nВведите новое название:"
end

# Ввод нового названия
def rename_new_name_input(new_name, *)
  # Валидация и сохранение
end
```

### 3. Валидация данных

- **Название проекта:**
  - Минимум 2 символа
  - Максимум 255 символов
  - Уникальность в рамках системы
  - Не может быть пустым

- **Slug проекта:**
  - Генерируется автоматически из названия через `Russian.translit`
  - Формат: `/A[a-z0-9._+-]+\Z/`
  - Уникальность в рамках системы

### 4. Проверка прав доступа

```ruby
def can_rename_project?(user, project)
  membership = user.membership_of(project)
  membership&.owner?
end
```

### 5. Обработка ошибок

- **Проект не найден:** "Проект с указанным slug не найден или недоступен"
- **Нет прав:** "У вас нет прав для переименования этого проекта. Только владелец (owner) может переименовывать проекты"
- **Название занято:** "Проект с таким названием уже существует"
- **Некорректное название:** "Название должно содержать от 2 до 255 символов"

## Сообщения пользователю

### Успешное переименование
```
✅ Проект успешно переименован!
Старое название: {old_name} ({old_slug})
Новое название: {new_name} ({new_slug})
```

### Список проектов для выбора
```
Выберите проект для переименования:

{номер}. {название} ({slug}) - {роль}
```

### Запрос нового названия
```
Проект: {project_name}
Введите новое название (2-255 символов):
```

## Интеграция с системой

### Обновление зависимых сущностей

При переименовании проекта автоматически обновляются:
- **Slug** через friendly_id
- **TimeShift** - записи времени продолжают ссылаться на проект по ID
- **Memberships** - членства в проекте
- **Invites** - приглашения в проект

### История изменений

- Время последнего обновления проекта (`updated_at`)
- Логирование действия в систему
- Возможность добавить audit trail в будущем

## Тестирование

### Unit тесты

- `RenameCommandTest` - тесты основного класса команды
- Валидация входных параметров
- Проверка прав доступа
- Корректность обновления slug

### Integration тесты

- Полный сценарий переименования через callback'и
- Обработка ошибочных ситуаций
- Проверка обновления зависимых данных

### Тестовые данные

```ruby
let(:project) { create(:project, name: 'Old Name', slug: 'old-name') }
let(:owner) { create(:user) }
let(:membership) { create(:membership, user: owner, project: project, role: 'owner') }
```

## Будущие улучшения

1. **История переименований:** Добавление модели `ProjectRenameHistory`
2. **Массовое переименование:** Возможность переименовать несколько проектов
3. **Undo функционал:** Отмена последнего переименования
4. **Валидация похожих названий:** Предупреждение о похожих именах проектов
5. **Интеграция с GitHub:** Обновление репозиториев при переименовании

## Версионирование

- **Версия 1.0:** Базовая функциональность переименования
- **Версия 1.1:** Добавление истории изменений
- **Версия 1.2:** Undo функционал
- **Версия 2.0:** Массовое переименование и продвинутые возможности

## Порядок разработки

1. Создать класс `RenameCommand`
2. Добавить callback обработчики в `TelegramCallbacks`
3. Реализовать базовую функциональность
4. Добавить валидацию и обработку ошибок
5. Написать тесты
6. Обновить документацию
7. Добавить команду в список доступных (`/help`)